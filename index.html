<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REQUIREMENTS</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    #statusMessage {
      margin-top: 20px;
      padding: 10px;
      font-weight: bold;
      text-align: center;
      display: none;
    }
    .success {
      color: green;
      background-color: #e6ffe6;
      border: 1px solid green;
    }
    .error {
      color: red;
      background-color: #ffe6e6;
      border: 1px solid red;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.png" alt="Company Logo" class="logo">
      <h2>REQUIREMENTS</h2>
    </div>

    <form id="crewForm" enctype="multipart/form-data">
      <div class="section-title">General Information</div>

      <div class="form-group">
        <label for="prism">PRISM NUMBER:</label>
        <input type="text" name="prism" id="prism" required>
      </div>

      <div class="form-group">
        <label for="address">ADDRESS:</label>
        <input type="text" name="address" id="address" required>
      </div>

      <div class="form-group">
        <label for="date">DATE:</label>
        <input type="date" name="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="crew">CREW:</label>
        <select name="crew" id="crew" required>
          <option value="">-- Select Crew --</option>
          <option value="ITG">ITG</option>
          <option value="TCS">TCS</option>
        </select>
      </div>

      <div class="section-title">Pictures</div>

      <div class="form-group">
        <label for="beforeImages">BEFORE / ANTES (2 MINIMUM)</label>
        <input type="file" name="beforeImages[]" id="beforeImages" multiple accept="image/*" required>
      </div>

      <div class="form-group">
        <label for="duringImages">DURING / DURANTE (2 MINIMUM INCLUDING DEPTH)</label>
        <input type="file" name="duringImages[]" id="duringImages" multiple accept="image/*" required>
      </div>

      <div class="form-group">
        <label for="afterImages">AFTER / DESPU√âS (2 MINIMUM AFTER RESTORATION)</label>
        <input type="file" name="afterImages[]" id="afterImages" multiple accept="image/*" required>
      </div>

      <div class="form-group">
        <label for="footage">FOOTAGE / PIETAJE</label>
        <input type="file" name="footage[]" id="footage" multiple accept="image/*" required>
      </div>

      <div class="form-group">
        <label for="asbuilt">ASBUILT / MAPA CON MEDIDAS</label>
        <input type="file" name="asbuilt[]" id="asbuilt" multiple accept="image/*" required>
      </div>

      <div class="button-container">
        <button type="submit" id="submitBtn">Enviar</button>
      </div>
    </form>

    <div id="statusMessage"></div>
  </div>

  <script>
  const form = document.getElementById("crewForm");
  const statusMessage = document.getElementById("statusMessage");
  const submitBtn = document.getElementById("submitBtn");

  const categories = ["beforeImages", "duringImages", "afterImages", "footage", "asbuilt"];

  // üñºÔ∏è Mostrar vista previa de im√°genes
  categories.forEach(category => {
    const input = document.getElementById(category);
    input.addEventListener("change", () => {
      const previewId = `${category}-preview`;
      let preview = document.getElementById(previewId);
      if (!preview) {
        preview = document.createElement("div");
        preview.id = previewId;
        preview.style.display = "flex";
        preview.style.flexWrap = "wrap";
        preview.style.gap = "10px";
        input.parentNode.appendChild(preview);
      }
      preview.innerHTML = "";
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement("img");
          img.src = reader.result;
          img.style.width = "100px";
          img.style.height = "auto";
          img.style.border = "1px solid #ccc";
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusMessage.style.display = "none";
    statusMessage.className = "";
    submitBtn.disabled = true;

    // ‚úÖ Validar m√≠nimo 2 im√°genes por categor√≠a
    for (const category of categories) {
      const files = document.getElementById(category).files;
      if (files.length < 2) {
        statusMessage.textContent = `‚ö†Ô∏è Debes subir al menos 2 im√°genes en "${category.toUpperCase()}".`;
        statusMessage.classList.add("error");
        statusMessage.style.display = "block";
        submitBtn.disabled = false;
        return;
      }
    }

    const formData = new FormData(form);
    const payload = {
      prism: formData.get("prism"),
      address: formData.get("address"),
      date: formData.get("date"),
      crew: formData.get("crew"),
      images: {}
    };

    for (const category of categories) {
      const files = formData.getAll(category + "[]");
      payload.images[category] = [];

      for (const file of files) {
        const base64 = await toBase64(file);
        payload.images[category].push({
          name: file.name,
          type: file.type,
          data: base64.split(",")[1]
        });
      }
    }

    try {
      const response = await fetch("https://script.google.com/macros/s/AKfycbyg_s1grJP_LNyODFPaxn1Gdd36Lo69Wfak1lBaEBUrKiURUNU2Pr7DSpG79OlwX0VWqg/exec", {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(payload),
        redirect: "follow"
      });

      const result = await response.text();

      if (result.toLowerCase().includes("correctamente")) {
        statusMessage.textContent = "‚úÖ Formulario enviado correctamente.";
        statusMessage.classList.add("success");
        form.reset();
        categories.forEach(cat => {
          const preview = document.getElementById(`${cat}-preview`);
          if (preview) preview.innerHTML = "";
        });
      } else {
        statusMessage.textContent = "‚ö†Ô∏è Error al enviar el formulario: " + result;
        statusMessage.classList.add("error");
      }
    } catch (error) {
      statusMessage.textContent = "‚ùå Error de conexi√≥n o servidor.";
      statusMessage.classList.add("error");
    }

    statusMessage.style.display = "block";
    submitBtn.disabled = false;

    setTimeout(() => {
      statusMessage.style.display = "none";
    }, 5000);
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>
</body>
</html>